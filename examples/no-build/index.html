<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fukict Runtime - No Build Example</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      .counter {
        margin: 20px 0;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .count {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
      }
      .list-item {
        padding: 10px;
        margin: 5px 0;
        background: #f0f0f0;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      // Import runtime from the built package
      import {
        Fragment,
        h,
        registerComponentHandler,
        render,
        replaceNode,
      } from '../../packages/runtime/dist/index.js';

      // Simple counter component using replaceNode
      function createCounter() {
        let count = 0;
        let rootNode = null;

        function increment() {
          count++;
          update();
        }

        function decrement() {
          count--;
          update();
        }

        function update() {
          // é‡æ–°åˆ›å»ºæ•´ä¸ªç»„ä»¶çš„ VNode
          const newVNode = h(
            'div',
            { class: 'counter' },
            h('h2', null, 'Simple Counter (Runtime + replaceNode)'),
            h('div', { class: 'count' }, `Count: ${count}`),
            h('button', { 'on:click': increment }, 'Increment'),
            h('button', { 'on:click': decrement }, 'Decrement'),
          );

          // ä½¿ç”¨ replaceNode æ›¿æ¢
          if (rootNode) {
            rootNode = replaceNode(rootNode, newVNode);
          }
        }

        // åˆ›å»ºåˆå§‹ VNode
        const vnode = h(
          'div',
          {
            class: 'counter',
            ref: el => {
              rootNode = el;
            },
          },
          h('h2', null, 'Simple Counter (Runtime + replaceNode)'),
          h('div', { class: 'count' }, `Count: ${count}`),
          h('button', { 'on:click': increment }, 'Increment'),
          h('button', { 'on:click': decrement }, 'Decrement'),
        );

        return vnode;
      }

      // Todo list component - ä½¿ç”¨ replaceNode é‡æ–°æ¸²æŸ“
      function createTodoList() {
        let todos = [
          { id: 1, text: 'Learn Fukict', done: false },
          { id: 2, text: 'Build something', done: false },
          { id: 3, text: 'Share with others', done: false },
        ];
        let nextId = 4;
        let rootNode = null;

        function addTodo() {
          const text = prompt('Enter todo:');
          if (text) {
            todos.push({ id: nextId++, text, done: false });
            update();
          }
        }

        function toggleTodo(id) {
          const todo = todos.find(t => t.id === id);
          if (todo) {
            todo.done = !todo.done;
            update();
          }
        }

        function removeTodo(id) {
          todos = todos.filter(t => t.id !== id);
          update();
        }

        function update() {
          // é‡æ–°åˆ›å»ºæ•´ä¸ª TodoList çš„ VNode
          const newVNode = renderTodoList();
          if (rootNode) {
            rootNode = replaceNode(rootNode, newVNode);
          }
        }

        function renderTodoList() {
          return h(
            'div',
            null,
            h('h2', null, 'Todo List (Runtime + replaceNode)'),
            h(
              'p',
              { style: { fontSize: '14px', color: '#666' } },
              'Note: ä½¿ç”¨ replaceNode é‡æ–°æ¸²æŸ“ã€‚æ¯”æ‰‹åŠ¨ DOM æ“ä½œç®€å•ï¼Œä½†æ¯” Widget çš„ diff/patch æ…¢ã€‚',
            ),
            h('button', { 'on:click': addTodo }, 'Add Todo'),
            h(
              'div',
              null,
              ...todos.map(todo =>
                h(
                  'div',
                  {
                    class: 'list-item',
                    style: {
                      textDecoration: todo.done ? 'line-through' : 'none',
                      opacity: todo.done ? '0.6' : '1',
                    },
                  },
                  h('input', {
                    type: 'checkbox',
                    checked: todo.done,
                    'on:change': () => toggleTodo(todo.id),
                  }),
                  h('span', { style: { marginLeft: '10px' } }, todo.text),
                  h(
                    'button',
                    {
                      'on:click': () => removeTodo(todo.id),
                      style: { marginLeft: '10px', fontSize: '12px' },
                    },
                    'Remove',
                  ),
                ),
              ),
            ),
          );
        }

        // åˆ›å»ºåˆå§‹ VNode
        const vnode = h(
          'div',
          {
            ref: el => {
              rootNode = el;
            },
          },
          renderTodoList(),
        );

        return vnode;
      }

      // è¯´æ˜ç»„ä»¶
      function Explanation() {
        return h(
          'div',
          {
            style: {
              background: '#fff3cd',
              border: '1px solid #ffc107',
              padding: '15px',
              borderRadius: '4px',
              marginBottom: '20px',
            },
          },
          h('h3', { style: { marginTop: 0 } }, 'âœ¨ Runtime æä¾›çš„èƒ½åŠ›'),
          h(
            'ul',
            { style: { marginBottom: 0 } },
            h('li', null, 'âœ… VNode â†’ DOM åˆå§‹æ¸²æŸ“ (render)'),
            h('li', null, 'âœ… ç”¨æ–° VNode æ›¿æ¢æ—§ DOM èŠ‚ç‚¹ (replaceNode)'),
            h('li', null, 'âœ… é€šè¿‡ JSX/hyperscript åˆ›å»º VNode'),
            h('li', null, 'âœ… æ‰©å±•æœºåˆ¶ (Component Handlers)'),
            h('li', null, 'âŒ ä¸æä¾› diff/patchï¼ˆéœ€è¦ Widget åŒ…ï¼‰'),
            h('li', null, 'ğŸ’¡ ä½¿ç”¨ replaceNode å¯ä»¥ç®€åŒ–æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ DOM'),
          ),
        );
      }

      // Component Handler Example: Simple Component Class
      class SimpleComponent {
        constructor(props) {
          this.props = props;
          this.state = { mounted: false };
        }

        render() {
          return h(
            'div',
            { class: 'simple-component' },
            h('h3', null, `Simple Component: ${this.props.title}`),
            h('p', null, this.props.description),
            h('p', null, `Mounted: ${this.state.mounted}`),
          );
        }

        onMounted() {
          this.state.mounted = true;
          console.log('SimpleComponent mounted!');
        }

        onBeforeUnmount() {
          console.log('SimpleComponent unmounting!');
        }
      }

      // Register component handler for SimpleComponent
      const unregisterSimpleComponent = registerComponentHandler({
        name: 'SimpleComponent',
        priority: 100,

        detect(fn) {
          // Check if function creates instances of SimpleComponent
          return (
            fn === SimpleComponent || fn.prototype instanceof SimpleComponent
          );
        },

        render(Component, props, children) {
          const instance = new Component({ ...props, children });
          const vnode = instance.render();
          vnode.__instance__ = instance;
          return vnode;
        },

        onMount(element, vnode) {
          if (
            vnode.__instance__ &&
            typeof vnode.__instance__.onMounted === 'function'
          ) {
            vnode.__instance__.onMounted();
          }
        },

        onUnmount(element, vnode) {
          if (
            vnode.__instance__ &&
            typeof vnode.__instance__.onBeforeUnmount === 'function'
          ) {
            vnode.__instance__.onBeforeUnmount();
          }
        },
      });

      // Example component using the registered handler
      function ComponentExample() {
        return h(SimpleComponent, {
          title: 'Component Handler Demo',
          description:
            'This component is rendered using a custom component handler.',
        });
      }

      // App with Fragment
      function App() {
        return h(
          Fragment,
          null,
          h('h1', null, 'Fukict Runtime - No Build Example'),
          Explanation(),
          ComponentExample(), // Add the component handler example
          h('hr', { style: { margin: '20px 0' } }),
          createCounter(),
          h('hr', { style: { margin: '40px 0' } }),
          createTodoList(),
        );
      }

      // Initial render
      render(App(), document.getElementById('app'));
    </script>
  </body>
</html>
