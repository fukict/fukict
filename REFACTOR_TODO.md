# Fukict 重构 TODO

## 阶段一：架构设计

### 1. 核心设计文档
- [x] 1.1 设计 runtime 注册机制（核心中的核心）
- [x] 1.2 runtime 包能力边界设计
- [x] 1.3 widget 包能力边界设计
- [x] 1.4 scheduler 包独立设计
- [x] 1.5 包依赖关系设计（改为 direct dependency）
- [x] 1.6 编写总体架构文档 docs/ARCHITECTURE.md
- [x] 1.7 更新 CLAUDE.md 和 REFACTOR_TODO.md

## 阶段二：详细设计文档编写

### 2. runtime 包详细设计
- [x] 2.1 编写 runtime DESIGN.md
  - [x] 注册机制详细设计
  - [x] VNode 结构设计
  - [x] DOM 操作抽象层设计
  - [x] 渲染流程设计
  - [x] 内置能力清单
  - [x] 开放能力清单

- [x] 2.2 编写 runtime HOOKS.md
  - [x] 7 种钩子详细设计
  - [x] 钩子执行策略
  - [x] 数据传递方式

### 3. widget 包详细设计
- [x] 3.1 编写 widget DESIGN.md
  - [x] Widget 类组件架构
  - [x] 函数组件架构
  - [x] Refs 机制设计
  - [x] Slots 机制设计
  - [x] 挂载/卸载/更新流程
  - [x] 数组渲染机制
  - [x] 脱围渲染机制
  - [x] 如何注册到 runtime

### 4. 编译工具链设计
- [x] 4.1 编写 babel-plugin DESIGN.md
  - [x] JSX 转换规则
  - [x] 事件分离机制
  - [x] hyperscript 调用生成

- [x] 4.2 编写 babel-preset-widget DESIGN.md
  - [x] 零配置预设设计
  - [x] 自动 defineWidget 规则
  - [x] 工具链集成

### 5. scheduler 包详细设计
- [x] 5.1 编写 scheduler DESIGN.md
  - [x] 调度策略设计
  - [x] 优先级队列设计
  - [x] 任务取消机制
  - [x] 与 widget 集成方式

### 6. 其他核心包设计文档
- [x] 6.1 router DESIGN.md
- [x] 6.2 flux DESIGN.md

### 7. 预留包规划文档
- [ ] 7.1 create 包规划文档
- [ ] 7.2 devtools 包规划文档

## 阶段三：核心设计评审和优化

### 8. 设计评审
- [ ] 8.1 runtime 注册机制设计评审（核心）
  - [ ] 接口是否足够灵活
  - [ ] 是否易于扩展
  - [ ] 性能影响评估
  - [ ] 类型安全性评估

- [ ] 8.2 widget 集成设计评审
  - [ ] 与 runtime 的边界是否清晰
  - [ ] 生命周期设计是否合理
  - [ ] Refs/Slots 机制是否足够强大
  - [ ] 脱围渲染是否易用

- [ ] 8.3 包依赖关系评审
  - [ ] 是否存在循环依赖
  - [ ] peer dependencies 是否合理
  - [ ] 用户使用是否简洁

- [ ] 8.4 文档完整性评审
  - [ ] 设计文档是否清晰
  - [ ] API 文档是否完整
  - [ ] 示例是否充分

### 9. 设计优化
- [ ] 9.1 根据评审结果优化 runtime 设计
- [ ] 9.2 根据评审结果优化 widget 设计
- [ ] 9.3 根据评审结果优化其他包设计
- [ ] 9.4 更新所有相关文档

## 阶段四：实施计划制定

### 10. 开发顺序规划
- [ ] 10.1 确定开发优先级
  - [ ] P0: runtime 核心 + 注册机制
  - [ ] P0: widget 基础实现
  - [ ] P1: babel-plugin
  - [ ] P1: scheduler
  - [ ] P2: router
  - [ ] P2: flux
  - [ ] P3: 预留包

- [ ] 10.2 制定里程碑
  - [ ] M1: runtime 可用（基础渲染）
  - [ ] M2: widget 可用（类组件 + 函数组件）
  - [ ] M3: 完整工具链（babel + scheduler）
  - [ ] M4: 生态完善（router + flux）

### 11. 测试策略
- [ ] 11.1 单元测试策略
- [ ] 11.2 集成测试策略
- [ ] 11.3 性能测试策略
- [ ] 11.4 类型测试策略

## 阶段五：实施（设计完成后开始）

### 12. runtime 实现
- [ ] 12.1 VNode 类型定义
- [ ] 12.2 hyperscript 实现
- [ ] 12.3 DOM 操作工具实现
- [ ] 12.4 注册机制实现（核心）
- [ ] 12.5 基础渲染流程实现
- [ ] 12.6 单元测试
- [ ] 12.7 文档更新

### 13. widget 实现
- [ ] 13.1 Widget 类基类实现
- [ ] 13.2 defineWidget 实现
- [ ] 13.3 Refs 管理实现
- [ ] 13.4 Slots 机制实现
- [ ] 13.5 注册到 runtime
- [ ] 13.6 挂载/卸载/更新实现
- [ ] 13.7 数组渲染实现
- [ ] 13.8 脱围渲染实现
- [ ] 13.9 单元测试
- [ ] 13.10 文档更新

### 14. scheduler 实现
- [ ] 14.1 调度器核心实现
- [ ] 14.2 优先级队列实现
- [ ] 14.3 任务取消实现
- [ ] 14.4 与 widget 集成
- [ ] 14.5 单元测试
- [ ] 14.6 文档更新

### 15. 其他包实现
- [ ] 15.1 babel-plugin 实现
- [ ] 15.2 babel-preset-widget 实现
- [ ] 15.3 router 实现
- [ ] 15.4 flux 实现

### 16. 集成和测试
- [ ] 16.1 创建示例项目
- [ ] 16.2 集成测试
- [ ] 16.3 性能测试
- [ ] 16.4 文档完善

## 关键设计问题（需要重点思考）

### runtime 注册机制
- 如何设计通用的钩子注册接口？
- 如何保证钩子执行顺序？
- 如何处理钩子返回值？
- 如何支持异步钩子？
- 如何避免钩子冲突？

### widget 扩展机制
- 如何通过注册机制完全控制组件渲染？
- 如何实现组件实例的生命周期管理？
- 如何实现 refs 自动注册和清理？
- 如何实现 slots 的高效提取和渲染？
- 如何实现脱围渲染（子组件不随父组件更新）？

### 数组节点渲染
- 如何注册数组节点的渲染逻辑？
- 是否需要 key 优化？如何设计？
- 如何与 widget 的 diff 机制配合？

### 包导出策略
- runtime 应该导出哪些 API？
- widget 应该重新导出哪些 runtime API？
- 如何防止用户直接使用 runtime？
- 如何保持类型完整性？

### 性能优化
- 注册机制的性能开销？
- 如何避免不必要的重渲染？
- 如何优化 diff 算法？
- 如何优化内存使用？

---

**注意事项**：
1. 每完成一个任务，立即更新此文档
2. 设计阶段不要涉及具体代码实现细节
3. 设计变更必须同步更新相关文档
4. 重点关注注册机制设计，这是整个架构的核心
