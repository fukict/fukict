# 设计决策记录

本文档记录 @fukict/i18n 的重要设计决策、权衡和对比分析。

## 核心设计决策

### 1. 为什么基于订阅模式而非 Context？

**决策**：使用订阅模式（类似 Flux），而非 Context 注入

**原因**：

1. **一致性**：与 Flux、Router 的设计模式保持一致
2. **显式更新**：Fukict 没有自动依赖追踪，需要手动 update
3. **性能可控**：可以精确控制订阅位置和更新范围
4. **简单性**：不需要额外的 Context 机制

**权衡**：

- ✅ 优点：简单、可控、性能好
- ❌ 缺点：需要手动订阅和取消订阅

**对比其他方案**：

| 方案     | 更新机制    | 学习成本 | 性能 | 适合场景  |
| -------- | ----------- | -------- | ---- | --------- |
| 订阅模式 | 手动 update | 低       | 高   | Fukict    |
| Context  | 自动更新    | 中       | 中   | React/Vue |
| 全局对象 | 手动刷新    | 低       | 低   | 简单场景  |

### 2. 为什么不内置复杂的格式化？

**决策**：使用浏览器内置的 Intl API，不重新实现

**原因**：

1. **体积**：避免打包大型格式化库
2. **标准化**：Intl API 是 Web 标准，兼容性好
3. **灵活性**：用户可以选择第三方库（如 date-fns）
4. **维护成本**：不需要维护复杂的格式化逻辑

**权衡**：

- ✅ 优点：体积小（< 3KB），标准化，易维护
- ❌ 缺点：旧浏览器需要 polyfill，功能有限

**Intl API 兼容性**：

- Chrome 24+
- Firefox 29+
- Safari 10+
- Edge 12+
- IE 11（部分支持）

### 3. 为什么支持嵌套和扁平两种结构？

**决策**：同时支持嵌套对象和扁平键名

**原因**：

1. **兼容性**：不同项目有不同的偏好
2. **灵活性**：大型项目用嵌套，小型项目用扁平
3. **迁移成本**：从其他 i18n 库迁移时更容易
4. **实现简单**：内部统一转换为扁平键名

**权衡**：

- ✅ 优点：灵活、兼容性好、易迁移
- ❌ 缺点：可能导致使用不一致

**推荐**：优先使用嵌套结构

### 4. 为什么不提供全局单例？

**决策**：每个模块独立创建 i18n 实例

**原因**：

1. **模块隔离**：不同应用模块可能有不同的翻译
2. **可测试性**：每个测试可以创建独立实例
3. **SSR 友好**：每个请求可以有独立的语言状态
4. **灵活性**：用户可以自己决定是否全局

**用户可以自己实现全局单例**：

```typescript
// i18n/index.ts
export const i18n = createI18n({ ... });

// 其他模块导入使用
import { i18n } from './i18n';
```

### 5. 为什么不支持 ICU MessageFormat？

**决策**：初版使用简单的变量插值，不支持 ICU 格式

**原因**：

1. **简单性**：大部分场景不需要复杂格式
2. **体积**：ICU 解析器会增加 5-10KB
3. **性能**：简单替换比解析更快
4. **渐进式**：可以在 v2.0 添加

**权衡**：

- ✅ 优点：简单、轻量、快速
- ❌ 缺点：不支持复杂的格式化（选择、性别等）

**未来计划**：v2.0 支持可选的 ICU MessageFormat

## 与其他方案对比

### vs vue-i18n

**vue-i18n** 是 Vue.js 官方推荐的国际化库。

**相同点**：

- 响应式翻译
- 支持插值和复数
- 类型安全支持（vue-i18n v9+）
- 懒加载支持

**不同点**：

| 特性              | @fukict/i18n      | vue-i18n     |
| ----------------- | ----------------- | ------------ |
| 更新机制          | 手动订阅 + update | 自动追踪依赖 |
| 体积              | < 3KB             | ~10KB        |
| 类型安全          | 完整支持          | 完整支持     |
| 格式化            | Intl API          | 内置 + Intl  |
| ICU MessageFormat | ❌                | ✅           |
| 学习成本          | 低                | 中           |
| 适用框架          | Fukict            | Vue.js       |

**适用场景**：

- **@fukict/i18n**：Fukict 应用，追求轻量和简单
- **vue-i18n**：Vue.js 应用，需要完整功能

### vs react-i18next

**react-i18next** 是 React 生态中最流行的 i18n 库。

**相同点**：

- 支持懒加载
- 支持回退语言
- 支持插值
- 丰富的生态

**不同点**：

| 特性     | @fukict/i18n | react-i18next          |
| -------- | ------------ | ---------------------- |
| 更新机制 | 订阅模式     | Context + Hooks        |
| 体积     | < 3KB        | ~15KB                  |
| 类型安全 | 完整支持     | 部分支持               |
| 格式化   | Intl API     | i18next 插件           |
| 生态     | 新           | 成熟（翻译管理平台等） |
| 学习成本 | 低           | 中                     |
| 适用框架 | Fukict       | React                  |

**适用场景**：

- **@fukict/i18n**：Fukict 应用，追求简洁
- **react-i18next**：React 应用，需要完整生态

### vs @lingui/core

**Lingui** 是一个注重开发体验的 i18n 库，支持编译时提取。

**相同点**：

- 完整的 TypeScript 支持
- 类型安全的翻译键
- 支持插值和复数

**不同点**：

| 特性       | @fukict/i18n | @lingui/core          |
| ---------- | ------------ | --------------------- |
| 工作方式   | 运行时翻译   | 编译时提取            |
| 体积       | < 3KB        | ~5KB                  |
| 类型安全   | 完整支持     | 完整支持              |
| 格式化     | Intl API     | ICU MessageFormat     |
| 编译时优化 | ❌           | ✅                    |
| 学习成本   | 低           | 高                    |
| 构建复杂度 | 低           | 高（需要 Babel 插件） |

**适用场景**：

- **@fukict/i18n**：快速开发，追求简单
- **@lingui/core**：大型项目，追求性能和体验

### vs i18next

**i18next** 是最流行的 JavaScript i18n 框架，框架无关。

**相同点**：

- 支持懒加载
- 支持插值和复数
- 支持回退
- 丰富的插件生态

**不同点**：

| 特性     | @fukict/i18n | i18next  |
| -------- | ------------ | -------- |
| 体积     | < 3KB        | ~10KB    |
| 类型安全 | 完整支持     | 需要配置 |
| 格式化   | Intl API     | 插件系统 |
| 生态     | 新           | 非常成熟 |
| 插件系统 | ❌           | ✅       |
| 学习成本 | 低           | 中       |

**适用场景**：

- **@fukict/i18n**：Fukict 应用，追求轻量
- **i18next**：需要丰富插件生态

## 技术权衡

### 1. 类型安全 vs 灵活性

**选择**：优先类型安全

```typescript
// ✅ 我们的方案：完整类型推导
const messages = { en: { hello: 'Hello' } };
const i18n = createI18n({ messages });
i18n.t('hello'); // ✅ 类型检查通过
i18n.t('invalid'); // ❌ TypeScript 错误

// ❌ 灵活但不安全
i18n.t('hello'); // ✅ 运行时可能出错
i18n.t('invalid'); // ✅ TypeScript 不报错，运行时报错
```

**权衡**：

- 牺牲了一些动态性（如运行时添加翻译键）
- 换取了编译时的安全性和开发体验

### 2. 自动追踪 vs 手动订阅

**选择**：手动订阅（符合 Fukict 理念）

```typescript
// ✅ 我们的方案：显式订阅
class App extends Fukict {
  mounted() {
    this.unsubscribe = i18n.subscribe(() => this.update());
  }
}

// ❌ 自动追踪（Vue/React）
// 组件自动知道何时更新，无需显式订阅
```

**权衡**：

- 需要手动管理订阅（增加代码）
- 但更可控，性能更好，符合 Fukict 设计理念

### 3. 功能丰富 vs 体积小

**选择**：体积小，核心功能

| 功能              | 是否包含 | 理由              |
| ----------------- | -------- | ----------------- |
| 基本翻译          | ✅       | 核心              |
| 变量插值          | ✅       | 常用              |
| 复数形式          | ✅       | 常用              |
| 数字格式化        | ✅       | 使用 Intl         |
| 日期格式化        | ✅       | 使用 Intl         |
| ICU MessageFormat | ❌       | 体积大，v2.0 考虑 |
| 性别选择          | ❌       | 使用场景少        |
| 货币转换          | ❌       | 应由专门库处理    |
| 翻译管理后台      | ❌       | 第三方工具        |

**目标体积**：< 3KB gzipped

## 未来演进方向

### 短期（v1.0）

- [x] 核心 I18n 类实现
- [x] createI18n 工厂函数
- [x] 类型安全的翻译键
- [x] 基本插值和复数支持
- [x] 懒加载支持
- [x] Intl API 集成

### 中期（v1.x）

- [ ] 开发工具集成（缺失翻译检测）
- [ ] 性能优化（缓存、批量通知）
- [ ] Vue DevTools / React DevTools 集成
- [ ] 翻译文件验证工具
- [ ] 自动提取翻译键工具

### 长期（v2.0）

- [ ] 可选的 ICU MessageFormat 支持
- [ ] 编译时提取翻译键（类似 Lingui）
- [ ] 翻译管理后台集成
- [ ] 性能分析工具
- [ ] 更丰富的格式化选项

## 为什么选择 @fukict/i18n？

### 适合你的场景

- ✅ 使用 Fukict 框架
- ✅ 追求轻量和简单
- ✅ 需要完整的 TypeScript 支持
- ✅ 基本的国际化需求
- ✅ 快速开发和迭代

### 不适合的场景

- ❌ 需要复杂的 ICU MessageFormat
- ❌ 需要成熟的翻译管理平台集成
- ❌ 使用 React/Vue 等其他框架
- ❌ 需要丰富的插件生态

## 参考资料

### 标准和规范

- [Intl API - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl)
- [ICU MessageFormat](https://unicode-org.github.io/icu/userguide/format_parse/messages/)
- [CLDR - Unicode](https://cldr.unicode.org/)

### 其他 i18n 库

- [vue-i18n](https://vue-i18n.intlify.dev/)
- [react-i18next](https://react.i18next.com/)
- [i18next](https://www.i18next.com/)
- [@lingui/core](https://lingui.dev/)
- [FormatJS](https://formatjs.io/)

### Fukict 相关

- [@fukict/flux 设计文档](../../flux/docs/DESIGN.md)
- [@fukict/router 文档](../../router/docs/README.md)

---

**文档状态**：设计阶段
**最后更新**：2025-01-15
